# Machine Learning Integration for KryptoBot

This document describes the machine learning components integrated into the KryptoBot trading system.

## Overview

KryptoBot now includes several machine learning components:

1. **ML Signal Enhancer**: A RandomForest classifier that enhances trading signals by predicting the probability of successful trades.
2. **Anomaly Detector**: An LSTM autoencoder neural network that identifies unusual market patterns that may indicate trading opportunities or risks.
3. **Ensemble Learning**: A voting ensemble of multiple ML models that provides more robust trading signals.
4. **Time Series Forecasting**: LSTM/GRU neural networks that predict future price movements to enhance trading decisions.

## Components

### ML Signal Enhancer

The ML Signal Enhancer uses a RandomForest classifier to enhance trading signals generated by traditional technical analysis strategies. It:

- Extracts features from market data (RSI, MACD, Bollinger Bands, etc.)
- Predicts the probability of a successful trade
- Adjusts position sizes based on confidence
- Filters out low-confidence signals

#### Features Used

- RSI (Relative Strength Index)
- MACD (Moving Average Convergence Divergence)
- MACD Signal Line
- Bollinger Bands (upper and lower)
- Volume Ratio
- Price Change
- ATR (Average True Range)
- Trend Strength

### Anomaly Detector

The Anomaly Detector uses an LSTM autoencoder neural network to identify unusual market patterns. It:

- Learns the normal patterns in market data
- Identifies deviations from these patterns
- Flags potential trading opportunities or risks
- Provides visualization of anomalies

#### Architecture

- LSTM Autoencoder with 64 units
- Dropout layers for regularization
- Time-distributed dense output layer
- Trained to reconstruct sequences of market data

### Ensemble Learning

The Ensemble Learning module combines predictions from multiple ML models to provide more robust trading signals. It:

- Integrates multiple model types (RandomForest, GradientBoosting, AdaBoost)
- Uses voting to combine model predictions
- Provides more reliable probability estimates
- Adjusts position sizes based on ensemble confidence

#### Models Used

- RandomForest Classifier
- Gradient Boosting Classifier
- AdaBoost Classifier

### Time Series Forecasting

The Time Series Forecasting module uses LSTM and GRU neural networks to predict future price movements. It:

- Predicts price movements for a configurable forecast horizon
- Combines predictions from multiple models for more robust forecasts
- Generates trading signals based on predicted trends
- Adjusts position sizes based on forecast confidence
- Provides visualization of forecasts

#### Architecture

- LSTM and GRU neural networks
- Sequence-to-sequence prediction
- Dropout and BatchNormalization for regularization
- Support for both univariate and multivariate forecasting

## Usage

### Training the Models

#### Train the ML Signal Enhancer

```bash
python train_ml_model.py
```

This will:
- Fetch historical data for symbols in the watchlist
- Generate features and labels
- Train the RandomForest model
- Save the model to `models/signal_model.joblib`
- Generate performance metrics and visualizations

#### Train the Anomaly Detector

```bash
python train_anomaly_detector.py [--symbols SYMBOLS] [--epochs EPOCHS] [--batch-size BATCH_SIZE]
```

This will:
- Fetch historical data for the specified symbols (or default symbols)
- Extract features for anomaly detection
- Train the LSTM autoencoder model
- Save the model to `models/anomaly_detector/model.h5`
- Generate performance metrics and visualizations

#### Train the Ensemble Model

```bash
python ensemble_learning.py
```

This will:
- Generate training data from historical market data
- Train multiple base models (RandomForest, GradientBoosting, AdaBoost)
- Create an ensemble model using voting
- Save the models to `models/ensemble/`
- Generate performance metrics and visualizations

#### Train the Time Series Forecasting Models

```bash
python time_series_forecasting.py
```

or

```bash
./start_forecast_bot.sh --train-lstm --train-gru --symbols "SPY AAPL MSFT"
```

This will:
- Fetch historical data for the specified symbols
- Train LSTM and/or GRU models for time series forecasting
- Save the models to `models/forecasting/`
- Generate performance metrics and visualizations
- Evaluate model performance on test data

### Feature Selection

KryptoBot now includes a feature selection module that identifies the most predictive features for the ML model. This helps improve model performance by focusing on the most important features.

#### Run Feature Selection

```bash
./run_feature_selection.sh
```

This will:
- Analyze feature importance from the trained model
- Try different feature selection methods:
  - Importance threshold (features with importance >= 0.05)
  - Top N features (top 5 most important features)
  - Recursive Feature Elimination with Cross-Validation (RFECV)
- Compare performance of models with different feature sets
- Select the best feature set based on F1 score improvement
- Update the ML model with the selected features

#### Feature Selection Results

The feature selection process generates several visualizations and metrics:
- `results/feature_selection/feature_importance.png`: Bar chart of feature importance
- `results/feature_selection/rfecv_scores.png`: Cross-validation scores for different numbers of features
- `results/feature_selection/model_comparison_*.png`: Performance comparison between original and optimized models
- `results/feature_selection/comparison_*.json`: Detailed comparison metrics

### Running the ML-Enhanced Trading Bot

#### Run with ML Signal Enhancer and Anomaly Detector

```bash
./start_ml_bot.sh [--train-ml] [--train-anomaly] [--symbols SYMBOLS] [--epochs EPOCHS] [--batch-size BATCH_SIZE]
```

Options:
- `--train-ml`: Train the ML Signal Enhancer before starting
- `--train-anomaly`: Train the Anomaly Detector before starting
- `--symbols`: Symbols to train the Anomaly Detector on
- `--epochs`: Number of training epochs for the Anomaly Detector
- `--batch-size`: Batch size for training

#### Run with Ensemble Learning

```bash
./start_ensemble_bot.sh [--train-ensemble] [--voting soft|hard] [--weights WEIGHTS]
```

Options:
- `--train-ensemble`: Train the ensemble model before starting
- `--voting`: Voting type for ensemble (soft or hard)
- `--weights`: Comma-separated weights for ensemble models (e.g., "1,2,1")

#### Run with Time Series Forecasting

```bash
./start_forecast_bot.sh [--train-lstm] [--train-gru] [--symbols SYMBOLS]
```

Options:
- `--train-lstm`: Train the LSTM forecasting model before starting
- `--train-gru`: Train the GRU forecasting model before starting
- `--symbols`: Symbols to train forecasting models for (space-separated)
- `--config`: Path to trading bot config file
- `--forecast-config`: Path to forecasting settings file

## Configuration

### ML Settings

ML settings can be configured in `config/ml_settings.json`:

```json
{
    "ml_enabled": true,
    "anomaly_detection_enabled": true,
    "min_confidence_threshold": 0.6,
    "position_size_multiplier": 1.0
}
```

- `ml_enabled`: Enable/disable ML signal enhancement
- `anomaly_detection_enabled`: Enable/disable anomaly detection
- `min_confidence_threshold`: Minimum confidence threshold for ML signals
- `position_size_multiplier`: Multiplier for position sizes based on ML confidence

### Ensemble Settings

Ensemble settings can be configured in `config/ensemble_settings.json`:

```json
{
    "ensemble_enabled": true,
    "confidence_threshold": 0.6,
    "position_size_multiplier": 1.2
}
```

- `ensemble_enabled`: Enable/disable ensemble signal enhancement
- `confidence_threshold`: Minimum confidence threshold for ensemble signals
- `position_size_multiplier`: Multiplier for position sizes based on ensemble confidence

### Forecasting Settings

Forecasting settings can be configured in `config/forecasting_settings.json`:

```json
{
    "enabled": true,
    "model_types": ["lstm", "gru"],
    "sequence_length": 60,
    "forecast_horizon": 5,
    "confidence_threshold": 0.7,
    "min_trend_strength": 0.02,
    "use_for_entry": true,
    "use_for_exit": true,
    "use_for_position_sizing": true,
    "position_size_multiplier": 1.5,
    "symbols": ["SPY", "QQQ", "AAPL", "MSFT", "AMZN", "GOOGL", "META", "TSLA"],
    "update_frequency": 24
}
```

- `enabled`: Enable/disable time series forecasting
- `model_types`: Types of models to use (lstm, gru)
- `sequence_length`: Number of time steps to use for prediction
- `forecast_horizon`: Number of time steps to forecast
- `confidence_threshold`: Minimum confidence threshold for forecast signals
- `min_trend_strength`: Minimum trend strength to generate a signal
- `use_for_entry`: Use forecasts for entry decisions
- `use_for_exit`: Use forecasts for exit decisions
- `use_for_position_sizing`: Use forecasts for position sizing
- `position_size_multiplier`: Multiplier for position sizes based on forecast confidence
- `symbols`: Symbols to generate forecasts for
- `update_frequency`: How often to update forecasts (in hours)

## Performance Metrics

### ML Signal Enhancer

Performance metrics are saved to `results/training_results.json` and include:

- Accuracy
- Feature importance
- Training samples
- Positive outcomes

Visualizations are saved to:
- `results/feature_importance.png`: Bar chart of feature importance
- `results/confusion_matrix.png`: Confusion matrix of model predictions

### Anomaly Detector

Performance metrics are saved to `results/anomaly_detector/training_results.json` and include:

- Threshold
- Training samples
- Final loss
- Final validation loss

Visualizations are saved to:
- `results/anomaly_detector/reconstruction_error_distribution.png`: Histogram of reconstruction errors
- `results/anomaly_detector/training_history.png`: Training and validation loss curves
- `results/anomaly_detector/{symbol}_anomalies.png`: Price charts with anomalies highlighted

### Ensemble Learning

Performance metrics are saved to `results/ensemble/training_results.json` and include:

- Base model metrics (accuracy, precision, recall, F1)
- Ensemble model metrics
- Feature columns
- Voting weights

Visualizations are saved to:
- `results/ensemble/model_comparison.png`: Bar chart comparing model performance
- `results/ensemble/metrics_by_model.png`: Performance metrics by model

### Time Series Forecasting

Performance metrics are saved to `results/forecasting/{model_type}_evaluation_results.json` and include:

- Mean Squared Error (MSE)
- Root Mean Squared Error (RMSE)
- Mean Absolute Error (MAE)
- RÂ² Score
- Test Loss

Visualizations are saved to:
- `results/forecasting/{model_type}_training_history.png`: Training and validation loss curves
- `results/forecasting/{model_type}_actual_vs_predicted.png`: Comparison of actual vs. predicted values
- `results/forecasting/{model_type}_forecast.png`: Forecast visualization with confidence intervals
- `results/forecasting/combined_forecast.png`: Combined forecast from multiple models

## Integration with Trading Bot

### ML Integration

The ML components are integrated with the trading bot through the `ml_integration.py` module, which:

1. Enhances trading signals with the ML Signal Enhancer
2. Detects anomalies with the Anomaly Detector
3. Adjusts position sizes based on ML confidence
4. Filters out low-confidence signals
5. Logs ML insights and anomalies

The integration is applied through the `trading_bot_ml_patch.py` script, which patches the trading bot's methods to incorporate ML functionality.

### Ensemble Integration

The ensemble learning is integrated with the trading bot through the `ensemble_integration.py` module, which:

1. Enhances trading signals with the ensemble model
2. Combines ensemble predictions with technical signals
3. Adjusts position sizes based on ensemble confidence
4. Filters out low-confidence signals
5. Logs ensemble insights

### Forecasting Integration

The time series forecasting is integrated with the trading bot through the `forecasting_integration.py` module, which:

1. Generates price forecasts using LSTM/GRU models
2. Combines forecasts from multiple models
3. Generates trading signals based on forecast trends
4. Adjusts position sizes based on forecast confidence and trend strength
5. Filters trading opportunities based on forecast signals
6. Triggers position exits when forecasts contradict current positions

## Files

### ML Components

- `ml_enhancer.py`: ML Signal Enhancer implementation
- `anomaly_detector.py`: Anomaly Detector implementation
- `ml_integration.py`: Integration of ML components with the trading bot
- `trading_bot_ml_patch.py`: Patches the trading bot with ML functionality
- `train_ml_model.py`: Script to train the ML Signal Enhancer
- `train_anomaly_detector.py`: Script to train the Anomaly Detector
- `feature_selection.py`: Script to identify and select the most predictive features
- `run_feature_selection.sh`: Shell script to run the feature selection process
- `run_ml_bot.py`: Script to run the trading bot with ML integration
- `start_ml_bot.sh`: Shell script to start the ML-enhanced trading bot

### Ensemble Components

- `ensemble_learning.py`: Ensemble Learning implementation
- `ensemble_integration.py`: Integration of ensemble learning with the trading bot
- `run_ensemble_bot.py`: Script to run the trading bot with ensemble integration
- `start_ensemble_bot.sh`: Shell script to start the ensemble-enhanced trading bot

### Time Series Forecasting

- `time_series_forecasting.py`: Module for time series forecasting
- `forecasting_integration.py`: Integration with the trading bot
- `run_forecast_bot.py`: Script to run the trading bot with forecasting
- `start_forecast_bot.sh`: Shell script to start the trading bot with forecasting

### Utilities

- `update_ml_model.py`: Script to update the ML model with selected features

## Dependencies

- scikit-learn: For RandomForest classifier, feature selection, and preprocessing
- TensorFlow: For LSTM autoencoder neural network
- keras: For LSTM/GRU neural networks
- pandas: For data manipulation
- numpy: For numerical operations
- matplotlib and seaborn: For visualization
- joblib: For model serialization 